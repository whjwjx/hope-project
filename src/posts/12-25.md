
---


icon: pen-to-square
date: 2022-01-09
category:
  - Cherry
tag:
  - red
  - small
  - round

# 每日技术随笔：权限系统的“双轨制”重构——从路由崩溃到精细化鉴权

**日期：** 2025年12月25日  
**分类：** 前端开发 / Vue3 / 架构设计

---

以下是为您准备的今日技术博客，记录了今天在权限系统优化过程中遇到的挑战与解决方案。

### **1. 引言**
在后台管理系统中，权限控制（RBAC）始终是核心环节。今天在优化 `Fantastic-admin` 框架的权限逻辑时，经历了一次从“简单修改”到“系统性重构”的过程。

### **2. 遇到的挑战：一个 `map` 引发的崩溃**
最初的需求非常简单：**将后端返回的权限对象数组转换为标题（title）数组，以便在页面中更直观地使用 `v-auth` 指令。**

我直接在 `userStore` 中做了如下修改：
```typescript
permissions.value = res.list.map(item => item.title)
```

**后果：** 整个系统瞬间瘫痪，控制台抛出大量 `TypeError: Cannot create property 'meta' on string` 错误。

**深度复盘：**
在成熟的后台框架中，`permissions` 往往承担着“一职多能”的角色：
1.  **鉴权**：作为字符串，供按钮级指令匹配。
2.  **路由生成**：作为对象，被路由系统递归处理并注入 `meta` 信息。
当我把对象数组强转为字符串数组时，路由系统试图在字符串（如 `"订单管理"`）上挂载 `meta` 属性，直接导致了溢出崩溃。

---

### **3. 解决方案：权限数据的“双轨制”**
为了兼顾路由系统的稳定性和业务鉴权的便捷性，我引入了“双轨制”存储方案：

*   **`permissions` (对象轨)**：保留后端原始的对象结构（包含 `path`, `component`, `children` 等），专供路由生成系统使用。
*   **`authButtons` (标识轨)**：新增一个扁平化的字符串数组，存储所有的权限 `code` 或 `title`，专供 `v-auth` 指令鉴权使用。

**核心代码实现：**
```typescript
async function getPermissions() {
  const res = await commonApi.getMenuTree()
  // 轨道1：原始对象，维持路由系统运转
  permissions.value = res.list || [] 
  // 轨道2：递归提取标识，服务于按钮级鉴权
  authButtons.value = flattenPermissionCodes(res.list) 
}
```

---

### **4. 架构进阶：解耦显示与逻辑**
在后续的优化中，我们意识到直接用 `title` 鉴权的风险——如果产品经理改了菜单名称，前端代码必须跟着改。

因此，我制定了一套**权限标识符 (Permission Code)** 规范：
*   后端返回唯一的 `code`（如 `community.leader.edit`）。
*   前端通过递归算法，无论权限点藏在多深的子菜单下，都能精准捕获。
*   编写了配套的《前后端对接文档》，明确了 `type`（目录/菜单/按钮）的划分。

---

### **5. 总结与启示**
1.  **敬畏底层框架数据流**：在修改全局 Store 数据时，必须回溯该数据的所有消费场景，避免“按下葫芦浮起瓢”。
2.  **职责单一原则**：显示的数据（Title）和逻辑的数据（Code）应当分离。
3.  **递归的力量**：处理树形结构（菜单、权限）时，一份健壮的递归算法是权限系统的灵魂。

**今日感悟：** 优秀的权限系统应当是后端配置灵活、前端调用简单的。每一次报错都是对底层原理加深理解的机会。

--- 

*作者：[你的名字/AI助手]*  
*记录于 Trae IDE - 您的智能编程伙伴*