---
title: 实习日志 - 2025-12-25
icon: pen-to-square
date: 2025-12-25
category:
  - 实习日志
tag:
  - 实习
  - 日志
---

### **技术优化总结：实现“三级颗粒度”的按钮权限控制**

#### **1. 问题背景：为何路由会崩溃？**
在重构权限系统时，若直接将 `userStore.permissions` 从**对象数组**（包含路由信息）强转为**字符串数组**（仅含名称），会导致路由系统在递归处理二级、三级节点时，无法在字符串上挂载 `meta` 属性，从而引发 `TypeError` 并导致页面导航中断。

---

#### **2. 后端实现：结构化权限树 (Code 模式)**
后端应提供一套具备层级关系的权限树，并为**三级按钮**定义唯一的权限标识（Code）：

*   **层级结构**：
    *   **一级 (目录)**：`community` (小区管理)
    *   **二级 (页面)**：`community.leader` (负责人管理页面)
    *   **三级 (操作)**：`community.leader.add` (**该页面下的新增按钮**)
*   **字段规范**：
    ```json
    {
      "title": "新增负责人",
      "code": "community.leader.add", // 唯一的权限标识
      "type": 3, // 1-目录, 2-菜单, 3-按钮
      "parentId": "..." 
    }
    ```

---

#### **3. 前端实现：权限数据“双轨制”**
前端通过一套数据、两种形态，完美兼容动态路由与三级按钮鉴权：

*   **轨道一：对象形态 (路由使用)**
    `permissions.value` 保留完整的树形对象，确保二级路由页面能正常加载和跳转。
*   **轨道二：扁平化形态 (按钮鉴权)**
    新增 `authButtons.value` 数组。通过**递归算法**提取树中所有 `type: 3` 的 `code`（或 `title`），形成扁平字符串数组：
    `['community.list', 'community.leader.add', 'community.leader.edit']`
*   **精准鉴权调用**：
    在 `community/leader/index.vue` 页面中，针对三级按钮进行控制：
    ```html
    <!-- 只有具备该二级页面下具体三级操作权限的用户才显示 -->
    <el-button v-auth="'community.leader.add'">新增负责人</el-button>
    ```

---

#### **4. 总结**
*   **颗粒度**：将权限细化到“二级页面下的三级按钮”，实现真正的精细化控制。
*   **解耦**：路由跳转由对象树负责，按钮显示由扁平化的 `code` 数组负责，互不干扰。
*   **安全**：后端通过 `code` 统一管理，前端只需关注标识符，即便菜单名称修改，功能权限依然稳固。
--- 
