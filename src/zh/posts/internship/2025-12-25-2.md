---
title: 实习日志 - 2025-12-25-2
icon: pen-to-square
date: 2025-12-25
category:
  - 实习日志
tag:
  - 实习
  - 日志
---
# UniApp 推荐算法埋点系统架构方案

## 1. 核心问题分析

通用的统计工具（如百度统计、Uni统计）无法满足推荐算法的需求，主要存在以下痛点：

*   **缺乏负样本（曝光数据）**：算法不仅要知道用户点了什么，必须知道用户**“看到了但没点”**什么（隐式反馈）。
*   **数据结构僵化**：通用工具字段固定，而算法需要灵活的业务字段（如 `item_vector_id`, `algo_version`, `ab_group`）。
*   **身份断层**：无法完美处理游客（UUID）到登录用户（User ID）的数据拼接，导致冷启动推荐失效。
*   **性能瓶颈**：推荐场景下（如无限流列表）数据产生速度极快，必须使用**本地缓冲+批量发送**机制，否则会阻塞小程序主线程。

---

## 2. 后端实现 (接收与存储)

**架构推荐**：Node.js/Go (接收层) -> Kafka (可选缓冲) -> **ClickHouse (核心存储)**

### 2.1 数据库设计 (ClickHouse)
ClickHouse 是处理海量日志的事实标准，查询快，压缩率高。

```sql
-- 创建基础日志表
CREATE TABLE ods_app_events (
    `event_id` UUID DEFAULT generateUUIDv4(),
    `event_type` String,          -- view(曝光), click, pay, stay
    `user_id` String,             -- 业务系统用户ID
    `device_uuid` String,         -- 游客设备ID
    `item_id` String,             -- 关联物品ID
    `duration` Int32,             -- 停留时长(ms)
    `params` String,              -- JSON字符串，存储 tags, category, alg_source 等灵活字段
    `os` String,                  -- ios, android
    `timestamp` DateTime64(3),    -- 毫秒级时间戳
    `server_time` DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (timestamp, event_type);
```

### 2.2 接收端接口 (Node.js/Koa 示例)
只负责极速接收和写入，不做复杂逻辑。

```javascript
const Koa = require('koa');
const Router = require('koa-router');
const { ClickHouse } = require('clickhouse'); // 需安装 clickhouse 驱动

const app = new Koa();
const clickhouse = new ClickHouse({ url: 'http://localhost:8123', db: 'default' });

// 接收埋点接口
router.post('/v1/tracker/collect', async (ctx) => {
    try {
        const { batch_list } = ctx.request.body; // 前端传来的数组
        
        // 简单清洗并格式化为 ClickHouse 插入格式
        const rows = batch_list.map(log => ({
            event_type: log.event,
            user_id: log.user_id || '',
            device_uuid: log.uuid,
            item_id: log.params.item_id || '',
            duration: log.params.duration || 0,
            params: JSON.stringify(log.params), // 复杂字段存JSON
            os: log.os,
            timestamp: log.ts
        }));

        // 异步批量写入 (生产环境建议先推 Kafka)
        await clickhouse.insert('ods_app_events', rows).toPromise();

        ctx.body = { code: 0, msg: 'success' };
    } catch (err) {
        console.error('埋点写入失败', err);
        ctx.body = { code: -1 }; // 即使失败也不要在前端报错，静默处理
    }
});
```

---

## 3. 前端实现 (UniApp SDK)

### 3.1 核心 SDK (`utils/tracker.js`)
实现**队列缓冲、断网重试、公共参数注入**。

```javascript
// utils/tracker.js
class Tracker {
    constructor() {
        this.queue = [];
        this.maxSize = 10; // 积攒10条发送
        this.timer = null;
        // 初始化公共参数
        const sys = uni.getSystemInfoSync();
        this.common = { os: sys.platform, model: sys.model };
        this.startLoop();
    }

    // 获取动态身份参数
    getIdentity() {
        return {
            user_id: uni.getStorageSync('user_id') || '',
            uuid: uni.getStorageSync('device_uuid') || '', // 需在App启动时生成
            ts: Date.now()
        };
    }

    // 埋点入口
    track(event, params = {}) {
        this.queue.push({
            event,
            ...this.common,
            ...this.getIdentity(),
            params
        });
        if (this.queue.length >= this.maxSize) this.flush();
    }

    // 发送逻辑
    flush() {
        if (!this.queue.length) return;
        const data = [...this.queue];
        this.queue = []; // 清空队列

        uni.request({
            url: 'https://api.你的域名.com/v1/tracker/collect',
            method: 'POST',
            data: { batch_list: data },
            fail: () => {
                // 发送失败，回收到Storage下次启动发
                // 生产环境需完善此处的重试逻辑
                console.log('埋点发送失败，暂存本地');
            }
        });
    }

    startLoop() {
        // 兜底：每5秒强制发送一次，防止数据一直不够10条
        setInterval(() => this.flush(), 5000);
    }
}
export default new Tracker();
```

### 3.2 曝光检测组件 (核心难点)
为了获取精准的“曝光+时长”，封装一个 Vue 组件包裹商品卡片。

**`components/track-exposure.vue`**

```vue
<template>
  <view class="exposure-box"><slot></slot></view>
</template>

<script>
export default {
  props: ['itemId', 'metaData'], // metaData 包含商品分类等信息
  data: () => ({ startTime: 0, observer: null }),
  mounted() {
    this.$nextTick(() => {
      // 微信小程序 API：监测元素是否进入视口
      this.observer = uni.createIntersectionObserver(this);
      this.observer.relativeToViewport({ bottom: 0 }).observe('.exposure-box', (res) => {
        if (res.intersectionRatio > 0) {
          // 进入视口：记录开始时间
          this.startTime = Date.now();
        } else if (this.startTime > 0) {
          // 离开视口：计算停留时长
          const duration = Date.now() - this.startTime;
          // 过滤掉小于 0.5秒 的快速滑动
          if (duration > 500) {
            this.$track.track('view_item', {
              item_id: this.itemId,
              duration: duration,
              ...this.metaData
            });
          }
          this.startTime = 0;
        }
      });
    });
  },
  beforeDestroy() {
    if (this.observer) this.observer.disconnect();
  }
}
</script>
```

### 3.3 业务使用

**`main.js`**
```javascript
import tracker from './utils/tracker';
Vue.prototype.$track = tracker;
```

**`pages/index/index.vue`**
```html
<template>
  <view>
    <!-- 列表循环 -->
    <view v-for="item in list" :key="item.id">
      
      <!-- 1. 自动处理曝光埋点 -->
      <track-exposure :itemId="item.id" :metaData="{cat: item.category}">
        
        <!-- 2. 点击埋点 -->
        <view @click="onItemClick(item)">
           {{ item.title }}
        </view>
        
      </track-exposure>
      
    </view>
  </view>
</template>

<script>
methods: {
  onItemClick(item) {
    // 强反馈埋点
    this.$track.track('click_item', { item_id: item.id });
    uni.navigateTo({ url: `/pages/detail?id=${item.id}` });
  }
}
</script>
```

---

## 4. 总结

1.  **自研是必须的**：为了满足推荐算法对“曝光数据”和“批量发送”的高要求，现成插件通常无法胜任。
2.  **前端轻量化**：前端 SDK 核心约 100 行代码，重点在于**队列缓冲**（省电省流）和**IntersectionObserver**（精准曝光）。
3.  **后端结构化**：直接使用 **ClickHouse** 存储扁平化日志，这能为你后续训练 Python 推荐模型节省 80% 的数据清洗时间。
4.  **数据价值**：
    *   `click` = 正样本 (用户喜欢)。
    *   `view` + `duration < 1s` = 负样本 (用户无视)。
    *   `view` + `duration > 3s` + `no click` = 困难负样本 (有点兴趣但没点，需优化标题/图片)。